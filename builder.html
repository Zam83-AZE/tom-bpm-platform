<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TOM Builder v7.0 (Resizable)</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.26.0/cytoscape.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dagre/0.8.5/dagre.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/cytoscape-dagre@2.5.0/cytoscape-dagre.min.js"></script>

    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: 'Segoe UI', sans-serif; 
            height: 100vh; 
            display: flex; 
            overflow: hidden; 
            background: #2d2d2d; /* Dark background for gaps */
        }

        /* --- RESIZABLE PANELS --- */
        .sidebar { 
            width: 250px; 
            min-width: 200px; 
            background: linear-gradient(180deg, #2c3e50 0%, #34495e 100%); 
            color: #fff; 
            display: flex; 
            flex-direction: column; 
        }

        .resizer-h {
            width: 5px;
            background: #1a252f;
            cursor: col-resize;
            transition: background 0.2s;
        }
        .resizer-h:hover { background: #3498db; }

        .main-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #f5f7fa;
            min-width: 400px;
        }

        .editor-panel {
            flex: 1; /* Height */
            padding: 20px;
            overflow-y: auto;
            background: #fff;
            min-height: 200px;
        }

        .resizer-v {
            height: 5px;
            background: #bdc3c7;
            cursor: row-resize;
            transition: background 0.2s;
        }
        .resizer-v:hover { background: #3498db; }

        .preview-panel {
            height: 300px;
            min-height: 100px;
            background: #1e1e1e;
            color: #4ec9b0;
            display: flex;
            flex-direction: column;
        }

        /* --- CODE MAXIMIZER --- */
        .code-wrapper { position: relative; }
        .btn-maximize {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #333;
            color: #fff;
            border: none;
            padding: 5px 10px;
            font-size: 12px;
            cursor: pointer;
            border-radius: 4px;
            opacity: 0.7;
        }
        .btn-maximize:hover { opacity: 1; }

        /* Fullscreen Code Mode */
        .code-wrapper.fullscreen {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            background: #fff;
            z-index: 1000;
            padding: 20px;
        }
        .code-wrapper.fullscreen textarea {
            height: calc(100vh - 50px) !important;
        }

        /* --- STANDARD STYLES --- */
        .file-manager { padding: 20px; background: #34495e; border-bottom: 2px solid #2c3e50; }
        .file-manager h3 { margin: 0 0 12px; font-size: 12px; color: #bdc3c7; text-transform: uppercase; }
        .btn-group { display: flex; gap: 8px; margin-bottom: 12px; }
        .btn-file, .btn-browse { flex: 1; color: #fff; padding: 8px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: bold; }
        .btn-file { background: #e67e22; }
        .btn-browse { background: #3498db; }
        select.process-list { width: 100%; padding: 8px; background: #ecf0f1; border: none; border-radius: 4px; }
        
        .list-header { padding: 10px 20px; background: #ecf0f1; color: #2c3e50; font-weight: bold; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #bdc3c7; font-size: 12px; }
        .btn-add { background: #27ae60; color: #fff; border: none; width: 24px; height: 24px; border-radius: 50%; cursor: pointer; }
        
        .activity-list { flex: 1; overflow-y: auto; list-style: none; }
        .activity-item { padding: 10px 20px; border-bottom: 1px solid #ecf0f1; cursor: pointer; color: #2c3e50; display: flex; justify-content: space-between; font-size: 13px; }
        .activity-item:hover { background: #34495e; color: #fff; }
        .activity-item.active { background: #3498db; color: #fff; font-weight: bold; }
        
        .badge { font-size: 9px; padding: 2px 6px; border-radius: 4px; background: rgba(255,255,255,0.2); margin-left: 5px; }
        
        /* Editor Form */
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 12px; color: #34495e; }
        input, select, textarea { width: 100%; padding: 8px; border: 1px solid #bdc3c7; border-radius: 4px; font-family: 'Consolas', monospace; font-size: 13px; }
        textarea.code { background: #2d2d2d; color: #f8f8f2; min-height: 150px; line-height: 1.4; }
        
        .config-section { background: #f8f9fa; padding: 15px; border: 1px solid #e0e0e0; border-radius: 4px; margin-bottom: 15px; }
        .sub-item { background: #fff; padding: 8px; margin-bottom: 5px; border: 1px solid #ddd; border-radius: 4px; display: flex; gap: 5px; }
        .btn-small { padding: 4px 8px; font-size: 10px; cursor: pointer; background: #95a5a6; color: #fff; border: none; border-radius: 3px; }
        .btn-small.delete { background: #e74c3c; }

        /* Preview Tabs */
        .tab-container { display: flex; background: #252526; border-bottom: 1px solid #3e3e42; }
        .tab-btn { flex: 1; padding: 8px; background: transparent; color: #888; border: none; cursor: pointer; font-size: 11px; font-weight: bold; }
        .tab-btn.active { color: #fff; background: #1e1e1e; border-bottom: 2px solid #3498db; }
        
        .tab-content { flex: 1; overflow: hidden; display: none; }
        .tab-content.active { display: block; position: relative; height: 100%; }
        #jsonPreview { padding: 10px; margin: 0; height: 100%; overflow: auto; font-size: 11px; }
        #cy { width: 100%; height: 100%; background: #1e1e1e; }
    </style>
</head>
<body>

    <div class="sidebar" style="width: 280px;">
        <div class="file-manager">
            <h3>üìÅ Fayl Meneceri</h3>
            <div class="btn-group">
                <button class="btn-file" onclick="createNewFile()">+ Yeni</button>
                <label class="btn-browse">üìÇ Y√ºkl…ô
                    <input type="file" id="fileUploader" accept=".js" multiple style="display:none" onchange="handleFileUpload(this)">
                </label>
            </div>
            <select class="process-list" id="processSelector" onchange="switchProcess(this.value)">
                <option value="">-- Fayl se√ßin --</option>
            </select>
        </div>
        <div class="list-header">
            <span>Addƒ±mlar</span>
            <button class="btn-add" onclick="addActivity()">+</button>
        </div>
        <ul class="activity-list" id="activityList"></ul>
    </div>

    <div class="resizer-h" id="dragMeH"></div>

    <div class="main-area">
        
        <div class="editor-panel" id="editorPanel" style="height: 60%;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:10px;">
                <h2 style="margin:0; font-size:18px; color:#2c3e50;">‚öôÔ∏è Redaktor</h2>
                <button class="btn-save" onclick="downloadCurrentFile()" style="padding:6px 12px; background:#27ae60; color:#fff; border:none; border-radius:4px; cursor:pointer; font-weight:bold;">üíæ Saxla</button>
            </div>

            <div class="form-group"><label>ID</label><input type="text" id="act_id" oninput="updateActivity('id',this.value)"></div>
            <div class="form-group"><label>Ad</label><input type="text" id="act_name" oninput="updateActivity('name',this.value)"></div>
            <div class="form-group"><label>Rol</label><input type="text" id="act_role" oninput="updateActivity('role',this.value)"></div>
            <div class="form-group"><label>T…ôsvir</label><textarea id="act_description" rows="2" oninput="updateActivity('description',this.value)"></textarea></div>
            
            <div class="form-group">
                <label>Tip</label>
                <select id="act_type" onchange="updateActivity('type',this.value)">
                    <option value="UserTask">User Task</option>
                    <option value="ServiceTask">Service Task</option>
                    <option value="SubProcess">Sub Process</option>
                    <option value="EndEvent">End Event</option>
                </select>
            </div>

            <div id="serviceConfig" class="config-section service" style="display:none">
                <div class="form-group"><label>Service Name</label><input type="text" id="act_serviceName" oninput="updateActivity('serviceName',this.value)"></div>
                
                <div class="form-group code-wrapper" id="codeWrapper">
                    <label>Simulation (JS Code) <button class="btn-maximize" onclick="toggleCodeFullscreen()">‚õ∂ Geni≈ül…ôndir</button></label>
                    <textarea class="code" id="act_simulation" oninput="updateSimulation(this.value)" spellcheck="false"></textarea>
                </div>
            </div>

            <div id="subProcessConfig" class="config-section subprocess" style="display:none">
                <div class="form-group"><label>Process Name</label><input type="text" id="act_processName" oninput="updateActivity('processName',this.value)"></div>
            </div>

            <hr>
            <div class="form-group"><label>üìù Inputlar</label><div id="inputsList"></div><button class="btn-small add" onclick="addInput()">+ Input</button></div>
            <hr>
            <div class="form-group"><label>üîÄ Ke√ßidl…ôr</label><div id="transitionsList"></div><button class="btn-small add" onclick="addTransition()">+ Ke√ßid</button></div>
        </div>

        <div class="resizer-v" id="dragMeV"></div>

        <div class="preview-panel" style="height: 40%;">
            <div class="tab-container">
                <button class="tab-btn active" onclick="switchTab('json')">JSON</button>
                <button class="tab-btn" onclick="switchTab('visual')">DIAQRAM</button>
            </div>
            <div id="tab-json" class="tab-content active">
                <pre id="jsonPreview">Fayl se√ßin...</pre>
            </div>
            <div id="tab-visual" class="tab-content">
                <div id="cy"></div>
            </div>
        </div>
    </div>

    <script>
        // --- RESIZABLE LOGIC ---
        const resizerH = document.getElementById('dragMeH');
        const sidebar = document.querySelector('.sidebar');
        const resizerV = document.getElementById('dragMeV');
        const editorPanel = document.querySelector('.editor-panel');
        const previewPanel = document.querySelector('.preview-panel');

        // Horizontal Resize (Sidebar)
        resizerH.addEventListener('mousedown', (e) => {
            document.addEventListener('mousemove', resizeH);
            document.addEventListener('mouseup', stopResizeH);
        });
        function resizeH(e) { sidebar.style.width = e.clientX + 'px'; }
        function stopResizeH() { document.removeEventListener('mousemove', resizeH); }

        // Vertical Resize (Editor vs Preview)
        resizerV.addEventListener('mousedown', (e) => {
            document.addEventListener('mousemove', resizeV);
            document.addEventListener('mouseup', stopResizeV);
        });
        function resizeV(e) {
            const newHeight = e.clientY - 40; // Top offset adjustment
            editorPanel.style.height = newHeight + 'px';
            previewPanel.style.height = `calc(100vh - ${newHeight}px)`;
        }
        function stopResizeV() { 
            document.removeEventListener('mousemove', resizeV); 
            // Diaqramƒ±n √∂l√ß√ºs√º d…ôyi≈üdiyi √º√ß√ºn onu yenil…ôyirik
            if(cy) cy.resize();
        }

        // --- CODE MAXIMIZER ---
        function toggleCodeFullscreen() {
            const wrapper = document.getElementById('codeWrapper');
            wrapper.classList.toggle('fullscreen');
            const btn = wrapper.querySelector('.btn-maximize');
            btn.innerText = wrapper.classList.contains('fullscreen') ? "‚úñ Baƒüla" : "‚õ∂ Geni≈ül…ôndir";
        }

        // --- TOM LOGIC (Standard) ---
        window.TOM_REGISTRY = {};
        let currentProcessName = null;
        let selectedActivityIndex = null;
        let cy = null;

        // (A≈üaƒüƒ±dakƒ± funksiyalar v6.0 il…ô eynidir - qƒ±sa saxladƒ±m)
        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            if(tab === 'json') {
                document.querySelector('button[onclick="switchTab(\'json\')"]').classList.add('active');
                document.getElementById('tab-json').classList.add('active');
            } else {
                document.querySelector('button[onclick="switchTab(\'visual\')"]').classList.add('active');
                document.getElementById('tab-visual').classList.add('active');
                setTimeout(() => { if(cy) cy.resize(); else renderVisualGraph(); }, 100);
            }
        }

        async function renderVisualGraph() {
            if (!currentProcessName) return;
            const p = TOM_REGISTRY[currentProcessName];
            
            if (typeof cytoscape('core', 'dagre') !== 'function') {
                 try { cytoscape.use(cytoscapeDagre); } catch(e) {}
            }

            let elements = [];
            p.activities.forEach(a => {
                let nodeClass = 'default';
                if(a.type === 'UserTask') nodeClass = 'user';
                else if(a.type === 'ServiceTask') nodeClass = 'service';
                else if(a.type === 'SubProcess') nodeClass = 'sub';
                else if(a.type === 'EndEvent') nodeClass = !a.id.toLowerCase().includes('reject') ? 'success' : 'fail';

                elements.push({
                    group: 'nodes',
                    data: { id: a.id, label: a.name, type: a.type, subName: a.processName },
                    classes: nodeClass
                });
            });

            if (p.transitions) {
                p.transitions.forEach(t => {
                    if (t.from && t.to) {
                        let label = t.condition ? t.condition.substring(0, 15) + '...' : '';
                        elements.push({ group: 'edges', data: { source: t.from, target: t.to, label: label } });
                    }
                });
            }

            if(cy) cy.destroy();
            cy = cytoscape({
                container: document.getElementById('cy'),
                elements: elements,
                style: [
                    { selector: 'node', style: { 'label': 'data(label)', 'color': '#fff', 'text-valign': 'center', 'text-halign': 'center', 'font-size': '11px', 'width': '120px', 'height': '50px', 'shape': 'round-rectangle', 'background-color': '#7f8c8d' } },
                    { selector: '.user', style: { 'background-color': '#3498db' } },
                    { selector: '.service', style: { 'background-color': '#9b59b6', 'shape': 'rectangle' } },
                    { selector: '.sub', style: { 'background-color': '#e67e22', 'shape': 'cut-rectangle' } },
                    { selector: '.success', style: { 'background-color': '#2ecc71', 'shape': 'ellipse' } },
                    { selector: '.fail', style: { 'background-color': '#e74c3c', 'shape': 'ellipse' } },
                    { selector: 'edge', style: { 'width': 2, 'line-color': '#bdc3c7', 'target-arrow-color': '#bdc3c7', 'target-arrow-shape': 'triangle', 'curve-style': 'bezier', 'label': 'data(label)', 'font-size': '9px', 'color': '#bdc3c7' } }
                ],
                layout: { name: 'dagre', rankDir: 'TB', padding: 30 }
            });
        }

        // --- Core Functions (Standard) ---
        function createNewFile() { const n = prompt("Proses adƒ±:"); if(n){ TOM_REGISTRY[n]={processName:n,startActivity:"",activities:[],transitions:[]}; switchProcess(n); refreshProcessList(); } }
        function refreshProcessList() { 
            const s=document.getElementById('processSelector'); s.innerHTML='<option>-- Se√ß --</option>'; 
            Object.keys(TOM_REGISTRY).forEach(k=>{ const o=document.createElement('option'); o.value=o.text=k; s.add(o) });
        }
        function switchProcess(n) { currentProcessName=n; document.getElementById('editorPanel').style.display='none'; selectedActivityIndex=null; renderActivityList(); updateJSONPreview(); }
        function handleFileUpload(input) { 
            Array.from(input.files).forEach(f=>{ const r=new FileReader(); r.onload=e=>{ eval(e.target.result); refreshProcessList(); }; r.readAsText(f); }); 
        }
        function downloadCurrentFile() {
            const d=TOM_REGISTRY[currentProcessName];
            let j=JSON.stringify(d,(k,v)=>typeof v==='function'?v.toString():v,4);
            j=j.replace(/"simulation":\s*"(.*?)"/gs,(m,f)=>`simulation: ${f.replace(/\\n/g,'\n').replace(/\\"/g,'"')}`);
            const b=new Blob([`window.TOM_REGISTRY["${currentProcessName}"]=${j}`],{type:"text/javascript"});
            const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download=`tom_${currentProcessName}.js`; a.click();
        }

        // --- Activity Logic ---
        function renderActivityList() {
            const l=document.getElementById('activityList'); l.innerHTML=""; const p=TOM_REGISTRY[currentProcessName];
            if(!p) return;
            p.activities.forEach((a,i)=>{
                const li=document.createElement('li'); li.className=`activity-item ${i===selectedActivityIndex?'active':''}`;
                li.innerHTML=`<span>${a.name}</span> <button class='btn-icon' onclick="deleteActivity(event,${i})">√ó</button>`;
                li.onclick=()=>loadActivity(i); l.appendChild(li);
            });
        }
        function loadActivity(i) {
            selectedActivityIndex=i; const a=TOM_REGISTRY[currentProcessName].activities[i];
            document.getElementById('editorPanel').style.display='block';
            renderActivityList();
            // Populate Form
            ['id','name','role','description','type','serviceName','processName'].forEach(f=> {
                const el=document.getElementById('act_'+f); if(el) el.value=a[f]||"";
            });
            if(a.simulation) document.getElementById('act_simulation').value = typeof a.simulation==='function'?a.simulation.toString():a.simulation;
            
            // Toggle Sections
            document.getElementById('serviceConfig').style.display=a.type==='ServiceTask'?'block':'none';
            document.getElementById('subProcessConfig').style.display=a.type==='SubProcess'?'block':'none';
            
            renderInputs(a); renderTransitions(a);
        }
        
        function updateActivity(f,v) { const a=TOM_REGISTRY[currentProcessName].activities[selectedActivityIndex]; a[f]=v; if(f==='type') loadActivity(selectedActivityIndex); updateJSONPreview(); renderActivityList(); }
        function updateSimulation(v) { const a=TOM_REGISTRY[currentProcessName].activities[selectedActivityIndex]; a.simulation=v; updateJSONPreview(); }
        
        function addActivity() { 
            const p=TOM_REGISTRY[currentProcessName]; 
            p.activities.push({id:"Step_"+(p.activities.length+1),name:"Yeni",type:"UserTask",inputs:[]}); 
            loadActivity(p.activities.length-1); 
        }
        function deleteActivity(e,i) { e.stopPropagation(); TOM_REGISTRY[currentProcessName].activities.splice(i,1); renderActivityList(); }

        function renderInputs(a) {
            const l=document.getElementById('inputsList'); l.innerHTML=""; 
            (a.inputs||[]).forEach((inp,i)=>{
                l.innerHTML+=`<div class='sub-item'><input value="${inp.name}" oninput="updInp(${i},'name',this.value)"><input value="${inp.label}" oninput="updInp(${i},'label',this.value)"><button class='btn-small delete' onclick="delInp(${i})">√ó</button></div>`;
            });
        }
        function renderTransitions(a) {
            const l=document.getElementById('transitionsList'); l.innerHTML=""; const p=TOM_REGISTRY[currentProcessName];
            (p.transitions||[]).filter(t=>t.from===a.id).forEach(t=>{
                const i=p.transitions.indexOf(t);
                l.innerHTML+=`<div class='sub-item'>TO:<input value="${t.to}" oninput="updTrans(${i},'to',this.value)">IF:<input value="${t.condition||''}" oninput="updTrans(${i},'condition',this.value)"><button class='btn-small delete' onclick="delTrans(${i})">√ó</button></div>`;
            });
        }

        window.addInput=()=>{ const a=TOM_REGISTRY[currentProcessName].activities[selectedActivityIndex]; if(!a.inputs)a.inputs=[]; a.inputs.push({name:"",type:"text"}); loadActivity(selectedActivityIndex); }
        window.updInp=(i,f,v)=>{ const a=TOM_REGISTRY[currentProcessName].activities[selectedActivityIndex]; a.inputs[i][f]=v; updateJSONPreview(); }
        window.delInp=(i)=>{ const a=TOM_REGISTRY[currentProcessName].activities[selectedActivityIndex]; a.inputs.splice(i,1); loadActivity(selectedActivityIndex); }
        
        window.addTransition=()=>{ const a=TOM_REGISTRY[currentProcessName].activities[selectedActivityIndex]; const p=TOM_REGISTRY[currentProcessName]; if(!p.transitions)p.transitions=[]; p.transitions.push({from:a.id,to:""}); loadActivity(selectedActivityIndex); }
        window.updTrans=(i,f,v)=>{ const p=TOM_REGISTRY[currentProcessName]; p.transitions[i][f]=v; updateJSONPreview(); }
        window.delTrans=(i)=>{ const p=TOM_REGISTRY[currentProcessName]; p.transitions.splice(i,1); loadActivity(selectedActivityIndex); }

        function updateJSONPreview() {
            if(currentProcessName) {
                document.getElementById('jsonPreview').innerText = JSON.stringify(TOM_REGISTRY[currentProcessName], null, 2);
                if(document.getElementById('tab-visual').classList.contains('active')) renderVisualGraph();
            }
        }
    </script>
</body>
</html>
