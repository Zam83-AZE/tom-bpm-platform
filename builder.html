<!DOCTYPE html>
<html lang="az">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TOM Builder v6.0 (Interactive)</title>
    
     <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.26.0/cytoscape.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dagre/0.8.5/dagre.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/cytoscape-dagre@2.5.0/cytoscape-dagre.min.js"></script>ipt>

    <style>
        * { box-sizing: border-box; margin: 0; padding: 0 }
        body { font-family: 'Segoe UI', sans-serif; height: 100vh; display: flex; overflow: hidden; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%) }
        .sidebar { width: 320px; background: linear-gradient(180deg, #2c3e50 0%, #34495e 100%); color: #fff; display: flex; flex-direction: column; border-right: 2px solid #1a252f; box-shadow: 4px 0 10px rgba(0, 0, 0, .1) }
        .file-manager { padding: 20px; background: #34495e; border-bottom: 2px solid #2c3e50 }
        .file-manager h3 { margin: 0 0 12px; font-size: 12px; color: #bdc3c7; text-transform: uppercase; letter-spacing: 1px; font-weight: 600 }
        .btn-group { display: flex; gap: 8px; margin-bottom: 12px }
        .btn-file, .btn-browse { flex: 1; color: #fff; padding: 10px; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 700; text-align: center; transition: all .3s }
        .btn-file { background: linear-gradient(135deg, #e67e22, #d35400) }
        .btn-browse { background: linear-gradient(135deg, #3498db, #2980b9) }
        select.process-list { width: 100%; padding: 12px; background: #ecf0f1; color: #2c3e50; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; outline: 0; font-size: 13px }
        .list-header { padding: 15px 20px; background: #ecf0f1; color: #2c3e50; font-weight: 700; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #bdc3c7; font-size: 13px; text-transform: uppercase; letter-spacing: .5px }
        .activity-list { flex: 1; overflow-y: auto; list-style: none; background: #fff }
        .activity-list::-webkit-scrollbar { width: 8px }
        .activity-list::-webkit-scrollbar-track { background: #f1f1f1 }
        .activity-list::-webkit-scrollbar-thumb { background: #bdc3c7; border-radius: 4px }
        .activity-item { padding: 14px 20px; border-bottom: 1px solid #ecf0f1; cursor: pointer; color: #2c3e50; display: flex; justify-content: space-between; align-items: center; transition: all .2s; font-size: 13px }
        .activity-item:hover { background: #f8f9fa; padding-left: 25px }
        .activity-item.active { background: linear-gradient(90deg, #e3f2fd 0%, #bbdefb 100%); border-left: 4px solid #2196f3; font-weight: 600 }
        .badge { font-size: 9px; padding: 3px 8px; border-radius: 12px; background: #ecf0f1; color: #7f8c8d; margin-left: 8px; font-weight: 700; text-transform: uppercase }
        .badge-svc { background: linear-gradient(135deg, #e8daef, #d7bde2); color: #7d3c98 }
        .badge-sub { background: linear-gradient(135deg, #fff3cd, #ffe69c); color: #856404 }
        .badge-end { background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 99%, #fecfef 100%); color: #d63031; }
        .btn-icon { background: 0 0; border: none; cursor: pointer; font-size: 18px; color: #e74c3c; opacity: .6; transition: all .2s }
        .btn-icon:hover { opacity: 1; transform: scale(1.2) }
        .btn-add { background: linear-gradient(135deg, #27ae60, #229954); color: #fff; border: none; width: 28px; height: 28px; border-radius: 50%; cursor: pointer; font-size: 16px; transition: all .3s }
        .btn-add:hover { transform: rotate(90deg) scale(1.1) }
        .editor { flex: 1; padding: 30px; overflow-y: auto; display: none; background: #fff }
        .editor-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid #3498db; padding-bottom: 20px; margin-bottom: 25px }
        .editor-header h2 { margin: 0; color: #2c3e50; font-size: 24px }
        .form-group { margin-bottom: 20px }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #34495e; font-size: 13px }
        input, select, textarea { width: 100%; padding: 12px; border: 2px solid #ecf0f1; border-radius: 6px; box-sizing: border-box; font-size: 14px; font-family: 'Segoe UI', sans-serif; transition: all .3s }
        input:focus, select:focus, textarea:focus { outline: 0; border-color: #3498db; box-shadow: 0 0 0 3px rgba(52, 152, 219, .1) }
        .config-section { background: #f8f9fa; padding: 20px; border-radius: 8px; border: 2px solid #e9ecef; margin-bottom: 20px }
        .sub-item { background: #fff; padding: 12px; margin-bottom: 8px; border: 2px solid #ecf0f1; border-radius: 6px; display: flex; gap: 8px; align-items: center; transition: all .2s }
        .btn-small { padding: 6px 12px; font-size: 11px; cursor: pointer; background: #95a5a6; color: #fff; border: none; border-radius: 4px; font-weight: 600; transition: all .2s }
        .btn-small.add { background: linear-gradient(135deg, #27ae60, #229954) }
        .btn-small.delete { background: linear-gradient(135deg, #e74c3c, #c0392b) }
        .btn-save { padding: 14px 28px; background: linear-gradient(135deg, #27ae60, #229954); color: #fff; border: none; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 14px; display: flex; align-items: center; gap: 8px; transition: all .3s }
        
        /* Preview Area */
        .preview { width: 40%; background: #1e1e1e; color: #4ec9b0; display:flex; flex-direction:column; border-left: 2px solid #2d2d2d }
        .tab-container { display: flex; background: #252526; border-bottom: 1px solid #3e3e42; }
        .tab-btn { flex:1; padding: 12px; background:transparent; color:#888; border:none; cursor:pointer; font-weight:bold; border-bottom:2px solid transparent; transition:all .3s}
        .tab-btn:hover { color: #fff; background: #2d2d2d; }
        .tab-btn.active { color: #fff; border-bottom: 2px solid #3498db; background: #1e1e1e; }
        
        .tab-content { flex:1; overflow:auto; padding:20px; display:none; position: relative; }
        .tab-content.active { display:block; }
        
        pre { color: #d4d4d4; line-height: 1.5; font-family: 'Consolas', monospace; font-size: 11px; }
        
        /* Cytoscape Container */
        #cy { width: 100%; height: 100%; background-color: #1e1e1e; }
        hr { border: none; border-top: 2px solid #ecf0f1; margin: 25px 0 }

        /* --- MOBILE RESPONSIVE CSS --- */
@media (max-width: 768px) {
    body {
        flex-direction: column; /* Yan-yana yox, alt-alta */
        height: auto;
        overflow: auto;
    }

    /* 1. Sol Paneli Gizl…ôt/G√∂st…ôr (Hamburger M…ôntiqi) */
    .sidebar {
        width: 100%;
        height: auto;
        position: relative;
        border-right: none;
        border-bottom: 2px solid #2c3e50;
        /* Real t…ôtbiqd…ô bunu JS il…ô toggle ed…ôc…ôyik, h…ôl…ôlik √ºstd…ô qalsƒ±n */
    }

    .file-manager {
        padding: 10px;
    }

    /* 2. Redaktoru Tam Ekran Et */
    .editor {
        width: 100%;
        padding: 15px;
        display: block; /* H…ômi≈ü…ô g√∂r√ºns√ºn */
    }

    /* 3. Preview Panelini A≈üaƒüƒ± Sal */
    .preview {
        width: 100%;
        height: 500px; /* Sabit h√ºnd√ºrl√ºk */
        border-left: none;
        border-top: 4px solid #2c3e50;
    }

    /* 4. D√ºym…ôl…ôri v…ô Inputlarƒ± B√∂y√ºt (Barmaq √º√ß√ºn) */
    button, .btn-file, .btn-browse, .btn-save {
        padding: 15px !important;
        font-size: 16px !important;
    }

    input, select, textarea {
        font-size: 16px !important; /* iOS-da zoom olmamasƒ± √º√ß√ºn min 16px olmalƒ±dƒ±r */
        padding: 15px !important;
    }

    .activity-item {
        padding: 20px; /* Daha rahat klikl…ôm…ôk √º√ß√ºn */
    }

    /* 5. Tablarƒ± rahatla≈üdƒ±r */
    .tab-btn {
        padding: 15px;
        font-size: 14px;
    }
}
    </style>
</head>

<body>
    <div class="sidebar">
        <div class="file-manager">
            <h3>üìÅ Fayl Meneceri</h3>
            <div class="btn-group">
                <button class="btn-file" onclick="createNewFile()">+ Yeni</button>
                <label class="btn-browse">üìÇ Y√ºkl…ô
                    <input type="file" id="fileUploader" accept=".js" multiple style="display:none"
                        onchange="handleFileUpload(this)">
                </label>
            </div>
            <select class="process-list" id="processSelector" onchange="switchProcess(this.value)">
                <option value="">-- Fayl se√ßin --</option>
            </select>
        </div>
        <div class="list-header">
            <span>Addƒ±mlar</span>
            <button class="btn-add" onclick="addActivity()">+</button>
        </div>
        <ul class="activity-list" id="activityList"></ul>
    </div>

    <div class="editor" id="editorPanel">
        <div class="editor-header">
            <h2>‚öôÔ∏è Redaktor</h2>
            <button class="btn-save" onclick="downloadCurrentFile()">
                <span>üíæ</span><span>Saxla</span>
            </button>
        </div>
        <div class="form-group">
            <label>ID</label>
            <input type="text" id="act_id" placeholder="Step_Card_Selection" oninput="updateActivity('id',this.value)">
        </div>
        <div class="form-group">
            <label>Ad</label>
            <input type="text" id="act_name" placeholder="Kart Se√ßimi" oninput="updateActivity('name',this.value)">
        </div>
        <div class="form-group">
            <label>Rol</label>
            <input type="text" id="act_role" placeholder="M√º≈üt…ôri" oninput="updateActivity('role',this.value)">
        </div>
        <div class="form-group">
            <label>T…ôsvir <span class="new-badge">YENƒ∞</span></label>
            <textarea id="act_description" rows="3" placeholder="Bu addƒ±mda n…ô ba≈ü verir?"
                oninput="updateActivity('description',this.value)"></textarea>
            <div class="help-text">Runtime-da info box g√∂st…ôril…ôc…ôk</div>
        </div>
        <div class="form-group">
            <label>Tip</label>
            <select id="act_type" onchange="updateActivity('type',this.value)">
                <option value="UserTask">User Task</option>
                <option value="ServiceTask">Service Task</option>
                <option value="SubProcess">Sub Process</option>
                <option value="EndEvent">End Event</option>
            </select>
        </div>
        <div id="serviceConfig" class="config-section service" style="display:none">
            <div class="alert"><strong>‚ö†Ô∏è</strong> Format: <strong>(data) => { ... }</strong></div>
            <div class="form-group">
                <label>Service Name</label>
                <input type="text" id="act_serviceName" placeholder="Svc_Fraud_AI"
                    oninput="updateActivity('serviceName',this.value)">
            </div>
            <div class="form-group">
                <label>Simulation</label>
                <textarea class="code" id="act_simulation" placeholder="(data) => { return { result: 'OK' }; }"
                    oninput="updateSimulation(this.value)"></textarea>
            </div>
        </div>
        <div id="subProcessConfig" class="config-section subprocess" style="display:none">
            <div class="form-group">
                <label>Process Name</label>
                <input type="text" id="act_processName" placeholder="Card_Identity"
                    oninput="updateActivity('processName',this.value)">
            </div>
        </div>
        <hr>
        <div class="form-group">
            <label>üìù Inputlar</label>
            <div id="inputsList"></div>
            <button class="btn-small add" onclick="addInput()">+ Input</button>
        </div>
        <hr>
        <div class="form-group">
            <label>üîÄ Ke√ßidl…ôr</label>
            <div id="transitionsList"></div>
            <button class="btn-small add" onclick="addTransition()">+ Ke√ßid</button>
        </div>
    </div>

    <div class="preview">
        <div class="tab-container">
            <button class="tab-btn active" onclick="switchTab('json')">JSON CODE</button>
            <button class="tab-btn" onclick="switchTab('visual')">DIAQRAM</button>
        </div>
        <div id="tab-json" class="tab-content active">
            <pre id="jsonPreview">Fayl se√ßin...</pre>
        </div>
        <div id="tab-visual" class="tab-content" style="padding:0; overflow:hidden">
            <div id="cy"></div>
        </div>
    </div>
   
    <script>
    window.TOM_REGISTRY = {};
    let currentProcessName = null;
    let selectedActivityIndex = null;
    let cy = null;

    function switchTab(tab) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        
        if(tab === 'json') {
            document.querySelector('button[onclick="switchTab(\'json\')"]').classList.add('active');
            document.getElementById('tab-json').classList.add('active');
        } else {
            document.querySelector('button[onclick="switchTab(\'visual\')"]').classList.add('active');
            document.getElementById('tab-visual').classList.add('active');
            setTimeout(renderVisualGraph, 100); // Render √º√ß√ºn vaxt veririk
        }
    }

    function renderVisualGraph() {
        if (!currentProcessName) return;
        const p = TOM_REGISTRY[currentProcessName];
        
        // Dagre layout-u qeydiyyatdan ke√ßiririk (Bunu yalnƒ±z bir d…ôf…ô etm…ôk daha yax≈üƒ±dƒ±r, amma burada t…ôhl√ºk…ôsizlik √º√ß√ºn yoxlayƒ±rƒ±q)
        if (typeof cytoscape('core', 'dagre') !== 'function') {
             try { cytoscape.use(cytoscapeDagre); } catch(e) { console.warn("Dagre already registered"); }
        }

        let elements = [];

        // Nodes (D√ºy√ºnl…ôr)
        p.activities.forEach(a => {
            // R…ông v…ô Forma m…ôntiqi (Data atributlarƒ± kimi g√∂nd…ôririk, Style i√ßind…ô yox)
            let nodeClass = 'default';
            if(a.type === 'UserTask') nodeClass = 'user';
            else if(a.type === 'ServiceTask') nodeClass = 'service';
            else if(a.type === 'SubProcess') nodeClass = 'sub';
            else if(a.type === 'EndEvent') { 
                nodeClass = !a.id.toLowerCase().includes('reject') ? 'success' : 'fail'; 
            }

            elements.push({
                group: 'nodes',
                data: { 
                    id: a.id, 
                    label: a.name, 
                    type: a.type, 
                    subName: a.processName 
                },
                classes: nodeClass // CSS klasslarƒ± kimi t…ôtbiq edirik
            });
        });

        // Edges (Oxlar)
        if (p.transitions) {
            p.transitions.forEach(t => {
                if (t.from && t.to) {
                    // ≈û…ôrti qƒ±saldƒ±rƒ±q
                    let label = t.condition ? t.condition.substring(0, 15) + (t.condition.length > 15 ? '...' : '') : '';
                    elements.push({
                        group: 'edges',
                        data: { source: t.from, target: t.to, label: label }
                    });
                }
            });
        }

        if(cy) cy.destroy(); // K√∂hn…ôni sil

        cy = cytoscape({
            container: document.getElementById('cy'),
            elements: elements,
            style: [
                {
                    selector: 'node',
                    style: {
                        'label': 'data(label)',
                        'text-valign': 'center',
                        'text-halign': 'center',
                        'color': '#fff',
                        'font-size': '12px',
                        'text-wrap': 'wrap',
                        'text-max-width': '100px',
                        'width': '140px',
                        'height': '60px',
                        'shape': 'round-rectangle',
                        'background-color': '#95a5a6'
                    }
                },
                // Node n√∂vl…ôri √º√ß√ºn still…ôr
                { selector: '.user', style: { 'background-color': '#3498db' } },
                { selector: '.service', style: { 'background-color': '#9b59b6', 'shape': 'rectangle' } },
                { selector: '.sub', style: { 'background-color': '#e67e22', 'shape': 'cut-rectangle', 'border-width': 2, 'border-color': '#fff' } },
                { selector: '.success', style: { 'background-color': '#2ecc71', 'shape': 'ellipse', 'width': '80px', 'height': '80px' } },
                { selector: '.fail', style: { 'background-color': '#e74c3c', 'shape': 'ellipse', 'width': '80px', 'height': '80px' } },
                
                // Edge stili
                {
                    selector: 'edge',
                    style: {
                        'width': 2,
                        'line-color': '#bdc3c7',
                        'target-arrow-color': '#bdc3c7',
                        'target-arrow-shape': 'triangle',
                        'curve-style': 'bezier',
                        'label': 'data(label)',
                        'font-size': '10px',
                        'color': '#bdc3c7',
                        'text-background-color': '#1e1e1e',
                        'text-background-opacity': 1,
                        'text-background-padding': '2px'
                    }
                },
                // Se√ßil…ônd…ô
                {
                    selector: ':selected',
                    style: {
                        'border-width': 2,
                        'border-color': '#fff',
                        'line-color': '#fff',
                        'target-arrow-color': '#fff'
                    }
                }
            ],
            layout: {
                name: 'dagre',
                rankDir: 'TB', // Top to Bottom
                padding: 50,
                spacingFactor: 1.2
            }
        });

        // Click Event
        cy.on('tap', 'node', function(evt){
            const node = evt.target;
            const type = node.data('type');
            const subName = node.data('subName');
            
            if(type === 'SubProcess' && subName) {
                if(confirm(`"${subName}" prosesin…ô ke√ßilsin?`)) {
                    switchProcess(subName);
                }
            }
        });
    }

    function createNewFile() {
        const n = prompt("Proses adƒ±:");
        if (!n || TOM_REGISTRY[n]) return alert(TOM_REGISTRY[n] ? "‚ùå Artƒ±q var!" : "");
        TOM_REGISTRY[n] = { processName: n, startActivity: "", activities: [], transitions: [] };
        refreshProcessList();
        document.getElementById('processSelector').value = n;
        switchProcess(n);
    }

    function handleFileUpload(input) {
        const files = Array.from(input.files);
        let loaded = 0;
        files.forEach(file => {
            const r = new FileReader();
            r.onload = e => {
                try {
                    eval(e.target.result);
                    loaded++;
                    if (loaded === files.length) {
                        refreshProcessList();
                        alert(`‚úÖ ${files.length} fayl y√ºkl…ôndi!`);
                        const match = e.target.result.match(/TOM_REGISTRY\[["'](.*?)["']\]/);
                        if (match?.[1]) {
                            document.getElementById('processSelector').value = match[1];
                            switchProcess(match[1]);
                        }
                    }
                } catch (err) {
                    alert("‚ùå X…ôta: " + err.message);
                }
            };
            r.readAsText(file);
        });
        input.value = '';
    }

    function refreshProcessList() {
        const s = document.getElementById('processSelector');
        s.innerHTML = '<option value="">-- Fayl se√ßin --</option>';
        Object.keys(TOM_REGISTRY).forEach(k => {
            const o = document.createElement('option');
            o.value = o.text = k;
            s.add(o);
        });
    }

    function downloadCurrentFile() {
        if (!currentProcessName) return alert("‚ö†Ô∏è Proses se√ßin!");
        const d = TOM_REGISTRY[currentProcessName];
        let j = JSON.stringify(d, (k, v) => typeof v === 'function' ? v.toString() : v, 4);
        j = j.replace(/"([a-zA-Z0-9_]+)":/g, "$1:").replace(/"simulation":\s*"(.*?)"/gs, (m, f) => `simulation: ${f.replace(/\\n/g, '\n').replace(/\\t/g, '\t').replace(/\\"/g, '"').replace(/\\\\/g, '\\')}`);
        let c = `/**\n * TOM Process - Generated by Builder v6.0\n * ${new Date().toLocaleString('az-AZ')}\n */\n\nwindow.TOM_REGISTRY=window.TOM_REGISTRY||{};\n\nwindow.TOM_REGISTRY["${currentProcessName}"]=${j};`;
        const b = new Blob([c], { type: "text/javascript" }),
            u = URL.createObjectURL(b),
            a = document.createElement('a');
        a.href = u;
        a.download = `tom_${currentProcessName.toLowerCase()}.js`;
        a.click();
        URL.revokeObjectURL(u);
        alert("‚úÖ Y√ºkl…ôndi!");
    }

    window.switchProcess = function(n) {
        if(!TOM_REGISTRY[n]) {
            if(n) alert("Proses tapƒ±lmadƒ±: " + n);
            return;
        }
        currentProcessName = n;
        document.getElementById('processSelector').value = n;
        document.getElementById('editorPanel').style.display = 'none';
        selectedActivityIndex = null; 
        
        renderActivityList();
        updateJSONPreview();
        
        if(document.getElementById('tab-visual').classList.contains('active')) {
            renderVisualGraph();
        }
    }

    function renderActivityList() {
        const l = document.getElementById('activityList');
        const p = TOM_REGISTRY[currentProcessName];
        l.innerHTML = "";

        if (!p.activities.length) {
            l.innerHTML = '<li style="padding:20px;text-align:center;color:#95a5a6">Addƒ±m yoxdur</li>';
            return;
        }

        p.activities.forEach((a, index) => {
            const li = document.createElement('li');
            li.className = `activity-item ${index === selectedActivityIndex ? 'active' : ''}`;
            
            let b = "";
            if (a.type === 'ServiceTask') b = "<span class='badge badge-svc'>API</span>";
            if (a.type === 'SubProcess') b = "<span class='badge badge-sub'>SUB</span>";
            if (a.type === 'EndEvent') b = "<span class='badge badge-end'>END</span>";
            
            li.innerHTML = `<span title="${a.description || 'T…ôsvir yox'}" style="flex:1">${a.name} <small style='color:#95a5a6'>(${a.id})</small> ${b}</span> <button class='btn-icon' onclick="deleteActivity(event, ${index})">√ó</button>`;
            li.onclick = () => loadActivity(index);
            l.appendChild(li);
        });
    }

    function loadActivity(index) {
        selectedActivityIndex = index;
        const p = TOM_REGISTRY[currentProcessName];
        const a = p.activities[index]; 
        if (!a) return;

        document.getElementById('editorPanel').style.display = 'block';
        renderActivityList();

        document.getElementById('act_id').value = a.id || "";
        document.getElementById('act_name').value = a.name || "";
        document.getElementById('act_role').value = a.role || "";
        document.getElementById('act_description').value = a.description || "";

        const t = a.type || "UserTask";
        document.getElementById('act_type').value = t;

        document.getElementById('serviceConfig').style.display = (t === 'ServiceTask') ? 'block' : 'none';
        document.getElementById('subProcessConfig').style.display = (t === 'SubProcess') ? 'block' : 'none';

        const svcInput = document.getElementById('act_serviceName');
        if (svcInput) svcInput.value = a.serviceName || "";

        const simInput = document.getElementById('act_simulation');
        if (simInput) {
            let simVal = "";
            if (typeof a.simulation === 'function') simVal = a.simulation.toString();
            else if (a.simulation) simVal = a.simulation;
            simInput.value = simVal;
        }

        const procInput = document.getElementById('act_processName');
        if (procInput) procInput.value = a.processName || "";

        if (typeof renderInputs === 'function') renderInputs(a);
        if (typeof renderTransitions === 'function') renderTransitions(a);
        if (typeof renderValidation === 'function' && window.renderValidation) renderValidation(a);
    }

    function updateActivity(f, v) {
        const a = getCurrentAct();
        if (!a) return;

        if (f === 'id') {
            const p = TOM_REGISTRY[currentProcessName];
            if (p.startActivity === a.id) {
                p.startActivity = v; 
            }
        }

        a[f] = v;

        if (f === 'type') {
            const isService = (v === 'ServiceTask');
            const isSubProcess = (v === 'SubProcess');
            document.getElementById('serviceConfig').style.display = isService ? 'block' : 'none';
            document.getElementById('subProcessConfig').style.display = isSubProcess ? 'block' : 'none';
            renderActivityList();
        }

        if (f === 'name' && window.renderValidation) {
            renderValidation(a);
        }

        if (['name', 'id', 'description'].includes(f)) {
            renderActivityList();
        }
        updateJSONPreview();
    }

    function updateSimulation(v) {
        const a = getCurrentAct();
        if (!a) return;
        a.simulation = v.trim();
        updateJSONPreview();
    }

    function addActivity() {
        if (!currentProcessName) return alert("‚ö†Ô∏è Proses se√ßin!");
        const p = TOM_REGISTRY[currentProcessName];

        let counter = p.activities.length + 1;
        let newId = "Step_" + counter;
        while (p.activities.find(x => x.id === newId)) {
            counter++;
            newId = "Step_" + counter;
        }

        const template = {
            id: newId,
            name: "Yeni Addƒ±m",
            role: "User",
            description: "",
            type: "UserTask",
            inputs: []
        };
        const cleanObject = JSON.parse(JSON.stringify(template));
        p.activities.push(cleanObject);

        if (!p.startActivity) p.startActivity = newId;

        renderActivityList();
        loadActivity(p.activities.length - 1);
        updateJSONPreview();
    }

    function deleteActivity(e, index) {
        e.stopPropagation();
        if (!confirm("Bu addƒ±mƒ± silm…ôk ist…ôdiyiniz…ô …ôminsiniz?")) return;

        const p = TOM_REGISTRY[currentProcessName];
        const actToDelete = p.activities[index];
        if (!actToDelete) return;
        const actId = actToDelete.id;

        p.activities.splice(index, 1);

        if (p.transitions) {
            p.transitions = p.transitions.filter(t => t.from !== actId && t.to !== actId);
        }

        if (p.startActivity === actId) {
            p.startActivity = "";
        }

        if (selectedActivityIndex === index) {
            document.getElementById('editorPanel').style.display = 'none';
            selectedActivityIndex = null;
        } else if (selectedActivityIndex > index) {
            selectedActivityIndex--;
        }

        renderActivityList();
        updateJSONPreview();
    }

    function renderInputs(a) {
        const l = document.getElementById('inputsList');
        l.innerHTML = "";
        if (!a.inputs?.length) {
            l.innerHTML = '<div style="padding:10px;text-align:center;color:#95a5a6;font-size:12px">Input yoxdur</div>';
            return;
        }
        a.inputs.forEach((i, x) => {
            const r = document.createElement('div');
            r.className = 'sub-item';
            r.style.flexWrap = "wrap";
            
            const safe = (str) => (str || '').replace(/"/g, '&quot;');

            let html = `
            <input type="text" value="${safe(i.name)}" placeholder="Key" style="flex:1; min-width:80px" oninput="updInp(${x},'name',this.value)">
            <input type="text" value="${safe(i.label)}" placeholder="Label" style="flex:2; min-width:100px" oninput="updInp(${x},'label',this.value)">
            <select style="width:80px" onchange="updInp(${x},'type',this.value)">
                <option value="text" ${i.type == 'text' ? 'selected' : ''}>Text</option>
                <option value="number" ${i.type == 'number' ? 'selected' : ''}>Number</option>
                <option value="select" ${i.type == 'select' ? 'selected' : ''}>Select</option>
            </select>
            <button class="btn-small delete" onclick="delInp(${x})">√ó</button>
        `;
            if (i.type === 'select') {
                html += `
                <div style="flex-basis:100%; margin-top:5px; padding-top:5px; border-top:1px dashed #eee">
                    <input type="text" value="${safe(i.options)}" 
                           placeholder="Opsiyalar: A, B, C (verg√ºll…ô ayƒ±rƒ±n)" 
                           style="width:100%; border-color:#3498db; background:#f0f8ff" 
                           oninput="updInp(${x},'options',this.value)">
                </div>
            `;
            }
            r.innerHTML = html;
            l.appendChild(r);
        });
    }

    function renderTransitions(a) {
        const l = document.getElementById('transitionsList'),
            p = TOM_REGISTRY[currentProcessName];
        l.innerHTML = "";
        if (!p.transitions) p.transitions = [];
        const mt = p.transitions.filter(t => t.from === a.id);
        if (!mt.length) {
            l.innerHTML = '<div style="padding:10px;text-align:center;color:#95a5a6;font-size:12px">Ke√ßid yox</div>';
            return;
        }
        mt.forEach(t => {
            const gi = p.transitions.indexOf(t),
                r = document.createElement('div');
            r.className = 'sub-item';
            r.innerHTML = `<strong style="font-size:11px;color:#7f8c8d">TO:</strong><input type="text" value="${t.to || ''}" placeholder="Step ID" style="flex:1" onchange="updTrans(${gi},'to',this.value)"><strong style="font-size:11px;color:#7f8c8d">IF:</strong><input type="text" value="${t.condition || ''}" placeholder="Condition" style="flex:1" onchange="updTrans(${gi},'condition',this.value)"><button class="btn-small delete" onclick="delTrans(${gi})">√ó</button>`;
            l.appendChild(r);
        });
    }

    window.addInput = () => {
        const a = getCurrentAct();
        if (!a) return;
        if (!a.inputs) a.inputs = [];
        a.inputs.push({ name: "", label: "", type: "text" });
        loadActivity(selectedActivityIndex);
        updateJSONPreview();
    };

    window.updInp = (i, f, v) => {
        const a = getCurrentAct();
        if (!a) return;
        a.inputs[i][f] = v;
        if (f === 'type') renderInputs(a);
        updateJSONPreview();
    };

    window.delInp = i => {
        const a = getCurrentAct();
        if (!a) return;
        a.inputs.splice(i, 1);
        loadActivity(selectedActivityIndex);
        updateJSONPreview();
    };

    window.addTransition = () => {
        const a = getCurrentAct();
        if (!a) return;
        const p = TOM_REGISTRY[currentProcessName];
        if (!p.transitions) p.transitions = [];
        p.transitions.push({ from: a.id, to: "", condition: "" });
        loadActivity(selectedActivityIndex);
        updateJSONPreview();
    };

    window.updTrans = (i, f, v) => {
        const p = TOM_REGISTRY[currentProcessName];
        if (!p?.transitions) return;
        p.transitions[i][f] = v;
        updateJSONPreview();
    };

    window.delTrans = i => {
        const p = TOM_REGISTRY[currentProcessName];
        if (!p?.transitions) return;
        p.transitions.splice(i, 1);
        loadActivity(selectedActivityIndex);
        updateJSONPreview();
    };

    function getCurrentAct() {
        if (!currentProcessName || selectedActivityIndex === null) return null;
        return TOM_REGISTRY[currentProcessName].activities[selectedActivityIndex];
    }

    function updateJSONPreview() {
        if (!currentProcessName) return;
        const d = TOM_REGISTRY[currentProcessName];
        document.getElementById('jsonPreview').innerText = JSON.stringify(d, (k, v) => typeof v === 'function' ? v.toString() : v, 2);
        
        if(document.getElementById('tab-visual').classList.contains('active')) {
            renderVisualGraph();
        }
    }

    window.onload = () => console.log("%cüöÄ TOM Builder v6.0", "color:#27ae60;font-size:16px;font-weight:bold");
</script>
    
</body>

</html>

